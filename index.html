<!DOCTYPE html>
<html lang="en">
   <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Engine Oil Excel Data Processor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #3548a1 0%, #370d62 100%);
        min-height: 100vh;
        color: white;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .file-upload {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 2px dashed rgba(255, 255, 255, 0.3);
        text-align: center;
      }
      .file-upload input[type="file"] {
        display: none;
      }
      .file-upload-label {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        padding: 15px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        display: inline-block;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }
      .file-upload-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }
      .tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        margin-bottom: 20px;
        overflow: hidden;
      }
      .tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-weight: bold;
      }
      .tab:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .tab.active {
        background: rgba(255, 255, 255, 0.3);
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .tab-content {
        display: none;
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .tab-content.active {
        display: block;
        overflow-x: auto;
        max-width: 100%;
        height: 500px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 12px;
        min-width: 120px;
      }
      th {
        background: rgba(255, 255, 255, 0.2);
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.9em;
      }
      tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .download-btn {
        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin: 20px auto;
        display: block;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }
      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }
      .download-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .info-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 4px solid #4caf50;
      }
      .product-type {
        font-weight: bold;
        color: #4caf50;
        margin-bottom: 10px;
      }
      .status {
        text-align: center;
        margin: 20px 0;
        font-weight: bold;
      }
      .status.success {
        color: #4caf50;
      }
      .status.error {
        color: #ff6b6b;
      }
      .category-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #4caf50;
      }
      .category-info h3 {
        margin: 0 0 10px 0;
        color: #4caf50;
      }
      .category-info p {
        margin: 5px 0;
      }
      .column-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #2196f3;
      }
      .column-info h3 {
        margin: 0 0 10px 0;
        color: #2196f3;
      }
      .column-list {
        font-size: 0.9em;
        line-height: 1.4;
      }
      .debug-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #ff9800;
        font-size: 0.9em;
      }
      .debug-info h3 {
        margin: 0 0 10px 0;
        color: #ff9800;
      }
      .pattern-match {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #9c27b0;
      }
      .pattern-match h3 {
        margin: 0 0 10px 0;
        color: #9c27b0;
      }
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
      }
      .pagination button {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      .pagination button:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.2);
      }
      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pagination span {
        font-weight: bold;
      }
    </style>
  </head>
   
  <body>
               
    <div class="container">
                       
      <h1>🛢️ Engine Oil Excel Data Processor</h1>

                       
      <div class="info-box">
                               
        <div class="product-type">Excel Fayl Emal Sistemi</div>
                               
        <p>
                              Bu sistem all_products.xlsx faylından məlumatları
          oxuyur və           5 ayrı           sheet-ə ayırır: Sheet1, Sheet2,
          Standart, Premium,           OEM.                
        </p>
                           
      </div>

                       
      <div class="column-info">
                               
        <h3>Sheet1 Sütunları</h3>
                               
        <div class="column-list">
                              <strong>Əsas Sütunlar:</strong> ID, Product name,
          Engine           oil,           Passenger car motor oil (PCMO), 1L,
          1.5L, 4L, 5L, 6L,           7L, 10L, 18L           <br />
                              <strong>Məhsul Adları:</strong> Aminol™ Special
          Generation           SLG1 0W-20           SP/GF-6A           <br />
                              <strong>Məhsul Təyinatı:</strong> Bidon (Açıq
          göy), Qapaq           (Qırmızı           falqa), Etiket (Orqinal),
          Qutu (Kıpaj), Palet                          
        </div>
                           
      </div>

                       
      <div class="column-info">
                               
        <h3>Sheet2 Sütunları</h3>
                               
        <div class="column-list">
                              <strong>Əsas Sütunlar:</strong> Məhsulun ID,
          Məhsulun adı,                     Spesifikasıyanın adı,
          Spesifikasıyanın tipi, Material,           Xarakteristika,          
          Ölçü vahidi, Miqdar, Material,           Xarakteristika          
          <br />
                              <strong>Materiallar:</strong> Bidon (1LT Açıq Göy
          Aminol),           Qapaq           (Qırmızı), Etiket (Aminol Special
          Generation), Qutu           (Kıpaj), Palet,           BE, GT, PA, SX,
          ZX                
        </div>
                           
      </div>

                       
      <div class="column-info">
                               
        <h3>Kateqoriya Məhsulları</h3>
                               
        <div class="column-list">
                              <strong>Standart:</strong> Standart keyfiyyət
          məhsulları                     <br />
                              <strong>Premium:</strong> ILSAC GF-6A, GF-6B, GF-5
          və API           SP, SN Plus           keyfiyyət məhsulları          
          <br />
                              <strong>OEM:</strong> 0W-20 SP/GF-6A və Top
          Quality yüksək           keyfiyyət           məhsulları              
           
        </div>
                           
      </div>

                       
      <div class="file-upload">
                       
        <input type="file" id="fileInput" accept=".xlsx,.xls" />                
        <label for="fileInput" class="file-upload-label">
                              📁 all_products.xlsx faylını seçin                
        </label>
                               
        <div class="status" id="status"></div>
                           
      </div>

                       
      <div id="debugInfo" class="debug-info" style="display: none">
                               
        <h3>Debug Info</h3>
                               
        <div id="debugContent"></div>
                           
      </div>

                       
      <div id="patternMatch" class="pattern-match" style="display: none">
                               
        <h3>Pattern Matching Results</h3>
                               
        <div id="patternContent"></div>
                           
      </div>

                       
      <div class="tabs">
                               
        <button class="tab active" onclick="showTab('sheet1', this)">
                              Sheet1                
        </button>
                               
        <button class="tab" onclick="showTab('sheet2', this)">Sheet2</button>  
                             
        <button class="tab" onclick="showTab('standart', this)">
                              Standart                
        </button>
                               
        <button class="tab" onclick="showTab('premium', this)">Premium</button>
                               
        <button class="tab" onclick="showTab('oem', this)">OEM</button>        
           
      </div>

                       
      <div id="sheet1" class="tab-content active">
                               
        <h2>Sheet1 - Məhsul Məlumatları</h2>
                               
        <table id="sheet1Table"></table>
                               
        <div class="pagination" id="sheet1Pagination"></div>
                           
      </div>

                       
      <div id="sheet2" class="tab-content">
                               
        <h2>Sheet2 - Material Spesifikasiyaları</h2>
                               
        <table id="sheet2Table"></table>
                               
        <div class="pagination" id="sheet2Pagination"></div>
                           
      </div>

                       
      <div id="standart" class="tab-content">
                               
        <h2>Standart Məhsullar</h2>
                               
        <div id="standartInfo" class="category-info" style="display: none">
                                       
          <h3>Standart Məhsul</h3>
                                       
          <p id="standartProduct"></p>
                                   
        </div>
                               
        <table id="standartTable"></table>
                               
        <div class="pagination" id="standartPagination"></div>
                           
      </div>

                       
      <div id="premium" class="tab-content">
                               
        <h2>Premium Məhsullar</h2>
                               
        <div id="premiumInfo" class="category-info" style="display: none">
                                       
          <h3>Premium Məhsul</h3>
                                       
          <p id="premiumProduct"></p>
                                   
        </div>
                               
        <table id="premiumTable"></table>
                               
        <div class="pagination" id="premiumPagination"></div>
                           
      </div>

                       
      <div id="oem" class="tab-content">
                               
        <h2>OEM Məhsullar</h2>
                               
        <div id="oemInfo" class="category-info" style="display: none">
                                       
          <h3>OEM Məhsul</h3>
                                       
          <p id="oemProduct"></p>
                                   
        </div>
                               
        <table id="oemTable"></table>
                               
        <div class="pagination" id="oemPagination"></div>
                           
      </div>

                       
      <button
        class="download-btn"
        id="downloadBtn"
        onclick="downloadExcel()"
        disabled
      >
                        📥 Yeni Excel Faylını Yüklə            
      </button>
                   
    </div>

               
    <script>
      let processedData = {
        sheet1: [],
        sheet2: [],
        standart: [],
        premium: [],
        oem: [],
      };

      let categoryProducts = {
        standart: "",
        premium: "",
        oem: "",
      };

      let originalSheet1 = [];
      let originalSheet2 = [];
      let dynamicBaseOils = [];

      const productNameMap = {
        "2t ta": "2T",
        "4t 10w-40 ma": "4T 10W-40",
        "to-4 sae 10w": "TO-4 10W",
        "to4 sae 5w-30": "TO-4 5W-30",
        "atf dexron ii": "ATF DX-IID",
        "atf dexron iii": "ATF DX-IIIH",
        "atf sp iv": "ATF SP-IV",
        "atf vi": "Aminol™ ATF DX-VI, Aminol™ ATF T-IV",
        "atf v": "ATF Mercon V",
        "synthetic gear oil 68": "GearSynth 68",
        "synthetic gear oil 100": "GearSynth 100",
        "synthetic gear oil 150": "GearSynth 150",
        "synthetic gear oil 220": "GearSynth 220",
        "synthetic gear oil 320": "GearSynth 320",
        "synthetic gear oil 460": "GearSynth 460",
        "synthetic gear oil 680": "GearSynth 680",
        "slideway oil 32": "SlideFlow 32",
        "slideway oil 46": "SlideFlow 46",
        "slideway oil 68": "SlideFlow 68",
        "slideway oil 100": "SlideFlow 100",
        "slideway oil 150": "SlideFlow 150",
        "slideway oil 220": "SlideFlow 220",
        "slideway oil 320": "SlideFlow 320",
        "compressor oil 32": "AirTec 32",
        "compressor oil 46": "AirTec 46",
        "compressor oil 68": "AirTec 68",
        "compressor oil 100": "AirTec 100",
        "compressor oil 150": "AirTec 150",
        "compressor oil 220": "AirTec 220",
        "compressor oil 320": "AirTec 320",
        "compressor oil vdl 46": "AirTec VDL 46",
        "compressor oil vdl 68": "AirTec VDL 68",
        "compressor oil vdl 100": "AirTec VDL 100",
        "compressor oil vdl 150": "AirTec VDL 150",
        "compressor oil vdl 220": "AirTec VDL 220",
        "compressor oil vdl 320": "AirTec VDL 320",
        "m 10dm sae 30 api cd гост 8581-78": "M-10DM",
        "m 10g2k sae 30 api cc гост 8581-78": "M-10G2K",
        "м-14в2 гост 12337-84": "M-14B2",
        "м-20в2": "M-20B2",
        "m 14g2k sae 40 api cc гост 8581-78": "M-14G2K",
        "m14d2 -tbn gosta gore dusuk": "M-14D2",
        "80w90 gl-4": "80W-90 GL-4",
        "75w90 gl-4": "75W-90 GL-4",
        "85w140 gl-5": "85W-140 GL-5",
        "75w90 gl-5": "75W-90 GL-5",
        "75w80 gl-4": "75W-80 GL-4",
        "75w80 gl-5": "75W-80 GL-5",
        "ep 90 gl-1": "90 GL-1",
        "transmission 80w-90 gl-5 ls": "Transmission 80W-90 LS GL-5",
        "transmission 85w-90 gl-5 ls": "Transmission 85W-90 LS GL-5",
        "synthetic transmission 75w-140 gl-5 ls":
          "Transmission 75W-140 LS GL-5",
        "transmission 85w140 gl-5 ls": "Transmission 85W-140 LS GL-5",
        "hydraulic oil 32": "Hydraulic 32",
        "hydraulic oil 46": "Hydraulic 46",
        "hydraulic oil 68": "Hydraulic 68",
        "hydraulic oil 100": "Hydraulic 100",
        "hydraulic oil 150": "Hydraulic 150",
        "hydraulic oil 220": "Hydraulic 220",
        "hydraulic oil 320": "Hydraulic 320",
        "hvlp 15 din 51524 part 3": "Hydraulic HVLP 15",
        "hvlp 22 din 51524 part 3": "Hydraulic HVLP 22",
        "hvlp 32 din 51524 part 3": "Hydraulic HVLP 32",
        "hvlp 46 din 51524 part 3": "Hydraulic HVLP 46",
        "hvlp 68 din 51524 part 3": "Hydraulic HVLP 68",
        "hvlp 100 din 51524 part 3": "Hydraulic HVLP 100",
        "hvlp 150 din 51524 part 3": "Hydraulic HVLP 150",
        "hydraulic oil 22 din 51524 part ii": "Hydraulic HLP 22",
        "hydraulic oil 32 din 51524 part ii": "Hydraulic HLP 32",
        "hydraulic oil 46 din 51524 part ii": "Hydraulic HLP 46",
        "hydraulic oil 68 din 51524 part ii": "Hydraulic HLP 68",
        "hydraulic oil 100 din 51524 part ii": "Hydraulic HLP 100",
        "hydraulic oil 150 din 51524 part ii": "Hydraulic HLP 150",
        "hydraulic oil 220 din 51524 part ii": "Hydraulic HLP 220",
        "hydraulic oil 320 din 51524 part ii": "Hydraulic HLP 320",
        "hydraulic oil 22 zn free": "Hydraulic HLP 22 Zinc Free",
        "hydraulic oil 32 zn free": "Hydraulic HLP 32 Zinc Free",
        "hydraulic oil 46 zn free": "Hydraulic HLP 46 Zinc Free",
        "hydraulic oil 68 zn free": "Hydraulic HLP 68 Zinc Free",
        "hydraulic oil 100 zn free": "Hydraulic HLP 100 Zinc Free",
        "hvlp 22 zn free": "Hydraulic HVLP 22 Zinc Free",
        "hvlp 32 zn free": "Hydraulic HVLP 32 Zinc Free",
        "hvlp 46 zn free": "Hydraulic HVLP 46 Zinc Free",
        "hvlp 68 zn free": "Hydraulic HVLP 68 Zinc Free",
        "antifreeze pink blue green red ready g12 -40":
          "Antifreeze G11 Ready Mix -40°C",
        "antifreeze pink blue green oncantrate": "Antifreeze G11 Concentrate",
        "antifreeze long life concantrate": "Antifreeze G12+ Concentrate",
        "antifreeze long life 50 ready": "Antifreeze G12+ Ready Mix -40°C",
      };

      const productPatterns = {
        oem: ["top quality", "premium - top quality", "premium-top quality"],
        premium: [
          "premium",
          "premium - standart",
          "premium-standart",
          "standart - premium",
          "standart-premium",
          "standart alternativ",
          "full premium",
          "polimerli versiya / premium",
          "polimerli versiya/premium",
          "top premium",
        ],
        standart: [
          "standart",
          "standard",
          "orjinal",
          "ekonomik",
          "ekonomik alternativ",
          "Ekonomik Alternativ (Katık Yok)",
          "katik yok",
          "ekonomik - standart",
          "ekonomik-standart",
          "ekonomik - standart - premium",
          "Standart Alternativ",
          "ekonomik-standart-premium",
          "standart - ekonomik",
          "standart-ekonomik",
          "polimerli versiya / standart",
          "polimerli versiya/standart",
          "polimerli standart",
          "Çok Ekonomik (Müşteri Onayı Olmadan Verilmemeli)",
          "Çok Ekonomik",
          "Müşteri Onayı Olmadan Verilmemeli",
        ],
      };

      const literSizes = [
        "0.25L",
        "0.5L",
        "1L",
        "1.5L",
        "4L",
        "5L",
        "6L",
        "7L",
        "10L",
        "18L",
        "20L",
        "25L",
        "30L",
        "60L",
        "200L",
        "1000L",
      ];
      const kiloSizes = ["4kg", "9kg", "14kg", "18kg", "180kg"];
      const allProductSizes = [...literSizes, ...kiloSizes];

      const packagingMaterials = ["Bidon", "Qapaq", "Etiket", "Qutu", "Palet"];
      let allMaterials = [...packagingMaterials];

      const rowsPerPage = 10;
      let currentPage = {
        sheet1: 1,
        sheet2: 1,
        standart: 1,
        premium: 1,
        oem: 1,
      };

      document
        .getElementById("fileInput")
        .addEventListener("change", handleFile);

      function sheetToArrayOfArrays(sheet) {
        const result = [];
        if (!sheet || !sheet["!ref"]) return result;
        const range = XLSX.utils.decode_range(sheet["!ref"]);
        for (let R = range.s.r; R <= range.e.r; ++R) {
          const row = [];
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = { c: C, r: R };
            const cell_ref = XLSX.utils.encode_cell(cell_address);
            const cell = sheet[cell_ref];
            row.push(cell ? cell.w : undefined);
          }
          result.push(row);
        }
        return result;
      }

      function extractDynamicBaseOils(sheet1) {
        const baseOils = new Set();

        for (let i = 1; i < sheet1.length; i++) {
          const row = sheet1[i];
          if (!row) continue;

          const code = row[2];
          if (code && typeof code === "string") {
            const trimmedCode = code.trim();
            if (
              trimmedCode.length >= 2 &&
              trimmedCode.length <= 3 &&
              /^[A-Z]+$/.test(trimmedCode)
            ) {
              if (!packagingMaterials.includes(trimmedCode)) {
                baseOils.add(trimmedCode);
              }
            }
          }
        }

        return Array.from(baseOils).sort();
      }

      function handleFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });

            if (workbook.SheetNames.length < 2) {
              showStatus("Fayl ən azı 2 sheet-ə malik olmalıdır!", "error");
              return;
            }

            const sheet1 = sheetToArrayOfArrays(
              workbook.Sheets[workbook.SheetNames[0]]
            );
            const sheet2 = sheetToArrayOfArrays(
              workbook.Sheets[workbook.SheetNames[1]]
            );

            dynamicBaseOils = extractDynamicBaseOils(sheet1);
            allMaterials = [...packagingMaterials, ...dynamicBaseOils];

            originalSheet1 = sheet1;
            originalSheet2 = sheet2;
            processedData.sheet1 = sheet1;
            processedData.sheet2 = sheet2;

            categorizeProducts(sheet1, sheet2);

            for (const key in currentPage) {
              currentPage[key] = 1;
            }

            displayTableWithPagination("sheet1Table", "sheet1", sheet1);
            displayTableWithPagination("sheet2Table", "sheet2", sheet2);
            displayCategoryTableWithPagination(
              "standartTable",
              "standart",
              processedData.standart
            );
            displayCategoryTableWithPagination(
              "premiumTable",
              "premium",
              processedData.premium
            );
            displayCategoryTableWithPagination(
              "oemTable",
              "oem",
              processedData.oem
            );

            updateCategoryInfo();
            document.getElementById("downloadBtn").disabled = false;
            showStatus("Fayl uğurla yükləndi və emal edildi!", "success");
          } catch (error) {
            showStatus(
              "Fayl oxunarkən xəta baş verdi: " + error.message,
              "error"
            );
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function categorizeProducts(sheet1, sheet2) {
        processedData.standart = [];
        processedData.premium = [];
        processedData.oem = [];
        categoryProducts.standart = "";
        categoryProducts.premium = "";
        categoryProducts.oem = "";

        const processedProductIds = new Set(); // Track processed product IDs to prevent duplicates

        for (let i = 1; i < sheet1.length; i++) {
          const headerRow = sheet1[i];
          if (!headerRow) continue;

          const productNameInBlock = headerRow[1];
          const isProductBlockHeader = productNameInBlock && headerRow[2];

          if (isProductBlockHeader) {
            let blockText = "";
            let blockEndIndex = i;
            let additivesData = {};

            for (let j = i; j < sheet1.length; j++) {
              const currentRow = sheet1[j];
              if (!currentRow) continue;

              if (j > i && currentRow[1] && currentRow[2]) {
                break;
              }

              blockEndIndex = j;
              if (currentRow[1]) {
                blockText += " " + currentRow[1];
              }

              const additiveCode = currentRow[2];
              const additivePercent = currentRow[3];
              if (
                additiveCode &&
                additivePercent &&
                allMaterials.includes(additiveCode.trim())
              ) {
                additivesData[additiveCode.trim()] = additivePercent;
              }
            }

            const normalizedBlockText = normalizeText(blockText);
            const foundMatches = {};

            for (const pattern of productPatterns.oem) {
              if (normalizedBlockText.includes(normalizeText(pattern))) {
                foundMatches["oem"] = pattern;
              }
            }
            for (const pattern of productPatterns.premium) {
              if (normalizedBlockText.includes(normalizeText(pattern))) {
                foundMatches["premium"] = pattern;
              }
            }
            for (const pattern of productPatterns.standart) {
              if (normalizedBlockText.includes(normalizeText(pattern))) {
                foundMatches["standart"] = pattern;
              }
            }

            const normalizedMapKey = normalizeText(productNameInBlock);
            const searchName =
              productNameMap[normalizedMapKey] || productNameInBlock;
            const normalizedSearchName = normalizeText(searchName);

            let bestMatchRow = null;
            const potentialMatches = [];
            for (let k = 1; k < sheet2.length; k++) {
              const sheet2Row = sheet2[k];

              const productIdFromSheet2 = sheet2Row ? sheet2Row[0] : undefined;
              if (
                !sheet2Row ||
                !sheet2Row[1] ||
                !productIdFromSheet2 ||
                productIdFromSheet2.toString().toLowerCase() === "id"
              ) {
                continue;
              }

              const sheet2ProductName = normalizeText(sheet2Row[1]);
              if (sheet2ProductName.includes(normalizedSearchName)) {
                potentialMatches.push(sheet2Row);
              }
            }

            if (potentialMatches.length === 1) {
              bestMatchRow = potentialMatches[0];
            } else if (potentialMatches.length > 1) {
              potentialMatches.sort(
                (a, b) => (a[1] || "").length - (b[1] || "").length
              );
              bestMatchRow = potentialMatches[0];
            }

            if (bestMatchRow) {
              const productId = bestMatchRow[0];

              // Check if this product ID has already been processed
              if (!processedProductIds.has(productId)) {
                const finalProductName = bestMatchRow[1];
                const numMatches = Object.keys(foundMatches).length;

                if (numMatches <= 1) {
                  const categoriesToAdd = ["standart", "premium", "oem"];
                  const matchedPattern =
                    numMatches === 1
                      ? Object.values(foundMatches)[0]
                      : "Təyin edilməyib";

                  categoriesToAdd.forEach((category) => {
                    const categoryData = generateSingleRowCategoryData(
                      headerRow,
                      bestMatchRow,
                      category,
                      finalProductName,
                      matchedPattern,
                      additivesData
                    );
                    processedData[category].push(categoryData);
                    if (!categoryProducts[category]) {
                      categoryProducts[category] = finalProductName;
                    }
                  });
                } else {
                  for (const category in foundMatches) {
                    const matchedPattern = foundMatches[category];
                    const categoryData = generateSingleRowCategoryData(
                      headerRow,
                      bestMatchRow,
                      category,
                      finalProductName,
                      matchedPattern,
                      additivesData
                    );
                    processedData[category].push(categoryData);
                    if (!categoryProducts[category]) {
                      categoryProducts[category] = finalProductName;
                    }
                  }
                }
                // Mark this product ID as processed
                processedProductIds.add(productId);
              }
            }
            i = blockEndIndex;
          }
        }
      }

      function generateSingleRowCategoryData(
        sheet1Row,
        sheet2Row,
        category,
        productName,
        matchedPattern,
        additivesData
      ) {
        const productId = sheet2Row[0] || `AL/EO-0001`;
        const engineOil = "Engine oil";
        const pcmo = "Passenger car motor oil (PCMO)";
        const specType = matchedPattern;

        const singleRow = [
          productId,
          engineOil,
          pcmo,
          productId,
          productName,
          `${productName}`,
          specType,
        ];

        allProductSizes.forEach((size) => {
          allMaterials.forEach((material) => {
            singleRow.push(material);
            const isAdditive = dynamicBaseOils.includes(material);

            if (isAdditive) {
              const percentage = additivesData[material];
              singleRow.push("<Xarakteristika yoxdur>");
              singleRow.push("faiz");
              if (percentage) {
                singleRow.push(`${percentage}%`);
              } else {
                singleRow.push("-");
              }
            } else {
              singleRow.push(
                getMaterialCharacteristic(material, size, productName)
              );
              singleRow.push("adəd");
              singleRow.push("1");
            }
          });
        });

        return singleRow;
      }

      function normalizeText(text) {
        if (!text) return "";
        return text
          .toString()
          .toLowerCase()
          .replace(/ğ/g, "g")
          .replace(/ü/g, "u")
          .replace(/ş/g, "s")
          .replace(/ı/g, "i")
          .replace(/ö/g, "o")
          .replace(/ç/g, "c")
          .replace(/ə/g, "e")
          .replace(/\r\n/g, " ")
          .replace(/[^\w\s-]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function getMaterialCharacteristic(material, size, productName) {
        const formattedSize = size.endsWith("L")
          ? size.replace("L", " L")
          : size.replace("kg", " kg");
        const characteristics = {
          Bidon: `${formattedSize} Açıq Göy Aminol (öz istehsal)`,
          Qapaq: `Qırmızı ${formattedSize} (50/22 telescopic)`,
          Etiket: `${productName} (BK-06)`,
          Qutu: `Kıpaj Aminol ${formattedSize}`,
          Palet: "1.14x1.14",
        };

        if (dynamicBaseOils.includes(material)) {
          return "<Xarakteristika yoxdur>";
        }

        return characteristics[material] || `${material} ${formattedSize}`;
      }

      function updateCategoryInfo() {
        const categories = ["standart", "premium", "oem"];
        categories.forEach((category) => {
          const infoDiv = document.getElementById(category + "Info");
          const productDiv = document.getElementById(category + "Product");
          if (categoryProducts[category]) {
            infoDiv.style.display = "block";
            productDiv.textContent = categoryProducts[category];
          } else {
            infoDiv.style.display = "none";
          }
        });
      }

      function processCell(cell) {
        if (cell === undefined || cell === null || cell === "") {
          return "-";
        }
        if (cell.toString() === "99.99999") {
          return "-";
        }
        return cell;
      }

      function showTab(tabName, element) {
        const contents = document.querySelectorAll(".tab-content");
        contents.forEach((content) => content.classList.remove("active"));

        const tabs = document.querySelectorAll(".tab");
        tabs.forEach((tab) => tab.classList.remove("active"));

        document.getElementById(tabName).classList.add("active");
        if (element) {
          element.classList.add("active");
        }

        if (tabName === "sheet1") {
          displayTableWithPagination(
            "sheet1Table",
            "sheet1",
            processedData.sheet1
          );
        } else if (tabName === "sheet2") {
          displayTableWithPagination(
            "sheet2Table",
            "sheet2",
            processedData.sheet2
          );
        } else if (tabName === "standart") {
          displayCategoryTableWithPagination(
            "standartTable",
            "standart",
            processedData.standart
          );
        } else if (tabName === "premium") {
          displayCategoryTableWithPagination(
            "premiumTable",
            "premium",
            processedData.premium
          );
        } else if (tabName === "oem") {
          displayCategoryTableWithPagination(
            "oemTable",
            "oem",
            processedData.oem
          );
        }
      }

      function showStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        if (type === "success") {
          setTimeout(() => {
            statusDiv.textContent = "";
            statusDiv.className = "status";
          }, 5000);
        }
      }

      function downloadExcel() {
        if (!processedData.sheet1.length && !processedData.sheet2.length) {
          showStatus("Əvvəlcə fayl yükləyin!", "error");
          return;
        }

        try {
          const wb = XLSX.utils.book_new();

          if (processedData.sheet1.length > 0) {
            const ws1 = XLSX.utils.aoa_to_sheet(processedData.sheet1);
            XLSX.utils.book_append_sheet(wb, ws1, "Sheet1");
          }

          if (processedData.sheet2.length > 0) {
            const ws2 = XLSX.utils.aoa_to_sheet(processedData.sheet2);
            XLSX.utils.book_append_sheet(wb, ws2, "Sheet2");
          }

          const createSheetWithHeaders = (data) => {
            const headers = [
              "ID",
              "Engine oil",
              "PCMO",
              "Məhsulun ID",
              "Məhsulun adı",
              "Spesifikasıyanın adı",
              "Spesifikasıyanın tipi",
            ];

            allProductSizes.forEach((size) => {
              allMaterials.forEach((material) => {
                const formattedSize = size.endsWith("L")
                  ? size.replace("L", " L")
                  : size.replace("kg", " kg");
                headers.push(`Material (${formattedSize} - ${material})`);
                headers.push(`Xarakteristika (${formattedSize} - ${material})`);
                headers.push(`Ölçü vahidi (${formattedSize} - ${material})`);
                headers.push(`Miqdar (${formattedSize} - ${material})`);
              });
            });

            return [headers, ...data];
          };

          if (processedData.standart.length > 0) {
            const standartWithHeaders = createSheetWithHeaders(
              processedData.standart
            );
            const ws3 = XLSX.utils.aoa_to_sheet(standartWithHeaders);
            XLSX.utils.book_append_sheet(wb, ws3, "Standart");
          }

          if (processedData.premium.length > 0) {
            const premiumWithHeaders = createSheetWithHeaders(
              processedData.premium
            );
            const ws4 = XLSX.utils.aoa_to_sheet(premiumWithHeaders);
            XLSX.utils.book_append_sheet(wb, ws4, "Premium");
          }

          if (processedData.oem.length > 0) {
            const oemWithHeaders = createSheetWithHeaders(processedData.oem);
            const ws5 = XLSX.utils.aoa_to_sheet(oemWithHeaders);
            XLSX.utils.book_append_sheet(wb, ws5, "OEM");
          }

          XLSX.writeFile(wb, "Processed_Engine_Oil_Data.xlsx");
          showStatus("Excel faylı uğurla yükləndi!", "success");
        } catch (error) {
          showStatus(
            "Excel faylı yaradılarkən xəta: " + error.message,
            "error"
          );
        }
      }

      function displayTableWithPagination(tableId, dataKey, allData) {
        const table = document.getElementById(tableId);
        const paginationDiv = document.getElementById(`${dataKey}Pagination`);

        if (!allData || allData.length === 0) {
          table.innerHTML =
            '<tr><td colspan="100%">Məlumat tapılmadı</td></tr>';
          paginationDiv.innerHTML = "";
          return;
        }

        const totalRows =
          allData.length -
          (dataKey === "sheet1" || dataKey === "sheet2" ? 1 : 0);
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const startRowIndex =
          (currentPage[dataKey] - 1) * rowsPerPage +
          (dataKey === "sheet1" || dataKey === "sheet2" ? 1 : 0);
        const endRowIndex = Math.min(
          startRowIndex + rowsPerPage,
          allData.length
        );

        let dataToDisplay = allData.slice(startRowIndex, endRowIndex);
        let headers = [];

        if (dataKey === "sheet1" || dataKey === "sheet2") {
          headers = allData[0] || [];
          if (allData.length > 0) {
            dataToDisplay = [headers, ...dataToDisplay];
          }
        }

        let html = "";
        dataToDisplay.forEach((row, index) => {
          html += "<tr>";
          (row || []).forEach((cell) => {
            const tag =
              (dataKey === "sheet1" || dataKey === "sheet2") && index === 0
                ? "th"
                : "td";
            const displayValue = processCell(cell);
            html += `<${tag}>${displayValue}</${tag}>`;
          });
          html += "</tr>";
        });

        table.innerHTML = html;
        renderPaginationControls(paginationDiv, dataKey, totalPages);
      }

      function displayCategoryTableWithPagination(tableId, dataKey, allData) {
        const table = document.getElementById(tableId);
        const paginationDiv = document.getElementById(`${dataKey}Pagination`);

        if (!allData || allData.length === 0) {
          table.innerHTML =
            '<tr><td colspan="100%">Məlumat tapılmadı</td></tr>';
          paginationDiv.innerHTML = "";
          return;
        }

        const totalRows = allData.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const startRowIndex = (currentPage[dataKey] - 1) * rowsPerPage;
        const endRowIndex = Math.min(
          startRowIndex + rowsPerPage,
          allData.length
        );

        const dataToDisplay = allData.slice(startRowIndex, endRowIndex);

        let html = "<tr>";
        const headers = [
          "ID",
          "Engine oil",
          "PCMO",
          "Məhsulun ID",
          "Məhsulun adı",
          "Spesifikasıyanın adı",
          "Spesifikasıyanın tipi",
        ];

        allProductSizes.forEach((size) => {
          allMaterials.forEach((material) => {
            const formattedSize = size.endsWith("L")
              ? size.replace("L", " L")
              : size.replace("kg", " kg");
            headers.push(`Material (${formattedSize} - ${material})`);
            headers.push(`Xarakteristika (${formattedSize} - ${material})`);
            headers.push(`Ölçü vahidi (${formattedSize} - ${material})`);
            headers.push(`Miqdar (${formattedSize} - ${material})`);
          });
        });

        headers.forEach((header) => {
          html += `<th>${header}</th>`;
        });
        html += "</tr>";

        dataToDisplay.forEach((row) => {
          html += "<tr>";
          (row || []).forEach((cell) => {
            const displayValue = processCell(cell);
            html += `<td>${displayValue}</td>`;
          });
          html += "</tr>";
        });

        table.innerHTML = html;
        renderPaginationControls(paginationDiv, dataKey, totalPages);
      }

      function renderPaginationControls(paginationDiv, dataKey, totalPages) {
        paginationDiv.innerHTML = "";
        if (totalPages <= 1) return;

        const prevButton = document.createElement("button");
        prevButton.textContent = "Əvvəlki";
        prevButton.disabled = currentPage[dataKey] === 1;
        prevButton.onclick = () => changePage(dataKey, -1);
        paginationDiv.appendChild(prevButton);

        const pageSpan = document.createElement("span");
        pageSpan.textContent = `Səhifə ${currentPage[dataKey]} / ${totalPages}`;
        paginationDiv.appendChild(pageSpan);

        const nextButton = document.createElement("button");
        nextButton.textContent = "Növbəti";
        nextButton.disabled = currentPage[dataKey] === totalPages;
        nextButton.onclick = () => changePage(dataKey, 1);
        paginationDiv.appendChild(nextButton);
      }

      function changePage(dataKey, direction) {
        currentPage[dataKey] += direction;
        if (dataKey === "sheet1") {
          displayTableWithPagination(
            "sheet1Table",
            "sheet1",
            processedData.sheet1
          );
        } else if (dataKey === "sheet2") {
          displayTableWithPagination(
            "sheet2Table",
            "sheet2",
            processedData.sheet2
          );
        } else if (dataKey === "standart") {
          displayCategoryTableWithPagination(
            "standartTable",
            "standart",
            processedData.standart
          );
        } else if (dataKey === "premium") {
          displayCategoryTableWithPagination(
            "premiumTable",
            "premium",
            processedData.premium
          );
        } else if (dataKey === "oem") {
          displayCategoryTableWithPagination(
            "oemTable",
            "oem",
            processedData.oem
          );
        }
      }
    </script>
  </body>
</html>
